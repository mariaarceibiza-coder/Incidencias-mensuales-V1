<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incidencias N√≥mina | Charo Ruiz Ibiza</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root{--bg:#FAF9F7;--card:#FFF;--sec:#F5F3F0;--txt:#1A1A1A;--txt2:#6B6B6B;--muted:#9B9B9B;--border:#E8E6E3;--accent:#C4A77D;--accent2:#A68B5B;--ok:#5B8C5A;--warn:#D4A03E;--err:#C45C5C;--info:#5B7C9C;--r:8px;--display:'Cormorant Garamond',serif;--body:'DM Sans',sans-serif}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--body);background:var(--bg);color:var(--txt);font-size:14px;line-height:1.5}
        .auth{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#FAF9F7,#F0EDE8)}
        .auth-box{background:var(--card);border-radius:16px;padding:48px;max-width:400px;width:100%;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .auth-logo{font-family:var(--display);font-size:28px;font-weight:600;margin-bottom:8px}.auth-sub{color:var(--txt2);font-size:12px;text-transform:uppercase;letter-spacing:2px;margin-bottom:32px}
        .form-group{text-align:left;margin-bottom:16px}.form-group label{display:block;font-size:11px;font-weight:600;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
        .form-input,.form-select{width:100%;padding:12px;border:1px solid var(--border);border-radius:var(--r);font-family:var(--body);font-size:14px;background:var(--bg)}.form-input:focus,.form-select:focus{outline:none;border-color:var(--accent)}
        .btn{padding:12px 24px;border-radius:var(--r);font-family:var(--body);font-size:14px;font-weight:600;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:8px;transition:.2s}
        .btn-p{background:var(--accent);color:#fff}.btn-p:hover{background:var(--accent2)}.btn-s{background:var(--sec);color:var(--txt);border:1px solid var(--border)}.btn-s:hover{background:var(--border)}
        .btn-block{width:100%}.btn-sm{padding:8px 16px;font-size:13px}
        .auth-toggle{margin-top:24px;color:var(--txt2);font-size:13px}.auth-toggle a{color:var(--accent);font-weight:600;text-decoration:none}
        .auth-err{background:#FEF2F2;color:var(--err);padding:12px;border-radius:var(--r);margin-bottom:16px;display:none;font-size:13px}
        .app{display:none;min-height:100vh}.app.active{display:flex}
        .sidebar{width:260px;background:var(--card);border-right:1px solid var(--border);position:fixed;height:100vh;display:flex;flex-direction:column;z-index:100}
        .sb-header{padding:24px;border-bottom:1px solid var(--border)}.sb-logo{font-family:var(--display);font-size:22px;font-weight:600}.sb-tag{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-top:4px}
        .sb-nav{flex:1;padding:16px 12px;overflow-y:auto}.nav-sec{margin-bottom:20px}.nav-title{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;padding:8px 12px}
        .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r);color:var(--txt2);font-size:14px;font-weight:500;cursor:pointer;transition:.15s;text-decoration:none}
        .nav-item:hover{background:var(--sec);color:var(--txt)}.nav-item.active{background:var(--accent);color:#fff}
        .sb-footer{padding:16px;border-top:1px solid var(--border)}.user-info{display:flex;align-items:center;gap:12px;margin-bottom:12px}
        .avatar{width:36px;height:36px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600}
        .user-name{font-weight:600;font-size:13px}.user-email{font-size:11px;color:var(--muted)}
        .main{flex:1;margin-left:260px;padding:32px}
        .page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;gap:16px}
        .page-title{font-family:var(--display);font-size:32px;font-weight:600}.page-sub{color:var(--txt2);margin-top:4px}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:32px}
        .stat{background:var(--card);border-radius:var(--r);padding:20px;border:1px solid var(--border)}.stat-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:8px}.stat-val{font-family:var(--display);font-size:28px;font-weight:600}.stat-sub{font-size:11px;color:var(--txt2);margin-top:4px}
        .card{background:var(--card);border-radius:var(--r);border:1px solid var(--border);margin-bottom:24px}.card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .card-title{font-family:var(--display);font-size:18px;font-weight:600}.card-body{padding:20px}
        table{width:100%;border-collapse:collapse}th{text-align:left;padding:10px 12px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;background:var(--sec);border-bottom:1px solid var(--border)}
        td{padding:12px;border-bottom:1px solid var(--border);font-size:13px}tr:hover{background:var(--bg)}
        .badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;text-transform:uppercase}.badge-ok{background:#E8F5E9;color:var(--ok)}.badge-warn{background:#FFF8E1;color:var(--warn)}.badge-err{background:#FFEBEE;color:var(--err)}.badge-info{background:#E3F2FD;color:var(--info)}
        .badge.click{cursor:pointer;transition:.15s}.badge.click:hover{opacity:.7}
        .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:.2s}.modal-bg.active{opacity:1;visibility:visible}
        .modal{background:var(--card);border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}.modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .modal-title{font-family:var(--display);font-size:22px;font-weight:600}.modal-close{background:none;border:none;cursor:pointer;color:var(--muted);font-size:24px}.modal-body{padding:20px}.modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:12px}
        .filter-bar{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}.filter-bar .form-select{width:auto;min-width:140px}
        .actions{display:flex;gap:4px}.act-btn{padding:6px;border:none;background:none;cursor:pointer;color:var(--muted);border-radius:var(--r)}.act-btn:hover{background:var(--sec);color:var(--txt)}.act-btn.del:hover{background:#FFEBEE;color:var(--err)}
        .empty{text-align:center;padding:40px;color:var(--muted)}.empty h3{font-family:var(--display);font-size:18px;color:var(--txt2);margin-bottom:8px}
        .toast-box{position:fixed;bottom:24px;right:24px;z-index:2000}.toast{background:var(--txt);color:#fff;padding:14px 20px;border-radius:var(--r);margin-top:8px;animation:slide .2s}.toast.ok{background:var(--ok)}.toast.err{background:var(--err)}
        @keyframes slide{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .loading{position:fixed;inset:0;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;z-index:3000}
        .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.hidden{display:none!important}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
        .calc-box{background:var(--sec);padding:16px;border-radius:var(--r);margin-top:16px}.calc-row{display:flex;justify-content:space-between;margin-bottom:8px}.calc-row:last-child{margin:0;border-top:1px solid var(--border);padding-top:8px}.calc-label{color:var(--txt2)}.calc-val{font-weight:600}.calc-val.hi{color:var(--ok)}
        @media(max-width:1024px){.sidebar{transform:translateX(-100%);transition:.3s}.sidebar.open{transform:translateX(0)}.main{margin-left:0}.mob-btn{display:flex!important}}
        .mob-btn{display:none;position:fixed;top:16px;left:16px;z-index:101;padding:12px;background:var(--card);border:1px solid var(--border);border-radius:var(--r);cursor:pointer}
        .local-badge{background:#E3F2FD;color:var(--info);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;margin-left:8px}
        .obj-table{width:100%;margin-top:12px}.obj-table td,.obj-table th{padding:6px 8px;font-size:12px}
    </style>
</head>
<body>
<div class="loading" id="load"><div class="spinner"></div></div>

<div class="auth" id="authScreen">
    <div class="auth-box">
        <div class="auth-logo">Charo Ruiz Ibiza</div>
        <div class="auth-sub">Gesti√≥n de Incidencias</div>
        <div class="auth-err" id="authErr"></div>
        <div id="loginForm">
            <div class="form-group">
                <label>Email</label>
                <input type="email" class="form-input" id="authEmail" required>
            </div>
            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" class="form-input" id="authPass" required>
            </div>
            <button class="btn btn-p btn-block" onclick="doLogin()">Iniciar sesi√≥n</button>
            <div class="auth-toggle">¬øNo tienes cuenta? <a href="#" onclick="showRegister()">Reg√≠strate</a></div>
        </div>
        <div id="registerForm" style="display:none">
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" class="form-input" id="regName" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" class="form-input" id="regEmail" required>
            </div>
            <div class="form-group">
                <label>Contrase√±a (m√≠n. 6 caracteres)</label>
                <input type="password" class="form-input" id="regPass" required>
            </div>
            <button class="btn btn-p btn-block" onclick="doRegister()">Crear cuenta</button>
            <div class="auth-toggle">¬øYa tienes cuenta? <a href="#" onclick="showLogin()">Inicia sesi√≥n</a></div>
        </div>
    </div>
</div>

<div class="app" id="app">
    <button class="mob-btn" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
    <aside class="sidebar" id="sidebar">
        <div class="sb-header">
            <div class="sb-logo">Charo Ruiz</div>
            <div class="sb-tag">Incidencias N√≥mina</div>
        </div>
        <nav class="sb-nav">
            <div class="nav-sec"><div class="nav-title">General</div><a class="nav-item active" data-p="dashboard">üìä Dashboard</a></div>
            <div class="nav-sec"><div class="nav-title">Incidencias</div>
                <a class="nav-item" data-p="comisiones">üí∞ Comisiones</a>
                <a class="nav-item" data-p="comisionesAnuales">üìà Comisiones Anuales</a>
                <a class="nav-item" data-p="dietas">‚úàÔ∏è Dietas</a>
                <a class="nav-item" data-p="domingos">üìÖ Domingos</a>
                <a class="nav-item" data-p="festivos">‚≠ê Festivos</a>
                <a class="nav-item" data-p="nocturnidad">üåô Nocturnidad</a>
                <a class="nav-item" data-p="horasExtras">‚è±Ô∏è Horas Extras</a>
                <a class="nav-item" data-p="bonificaciones">üéØ Bonif. Asistencia</a>
            </div>
            <div class="nav-sec"><div class="nav-title">Config</div>
                <a class="nav-item" data-p="empleados">üë• Empleados</a>
                <a class="nav-item" data-p="tiendas">üè™ Tiendas</a>
                <a class="nav-item" data-p="objetivosPage">üéØ Objetivos</a>
                <a class="nav-item" data-p="ajustesPage">‚öôÔ∏è Ajustes</a>
                <a class="nav-item" data-p="exportar">üì• Exportar</a>
            </div>
        </nav>
        <div class="sb-footer">
            <div class="user-info"><div class="avatar" id="avatar">M</div><div><div class="user-name" id="uName">Usuario</div><div class="user-email" id="uEmail">Cloud<span class="local-badge">‚òÅÔ∏è</span></div></div></div>
            <button class="btn btn-s btn-sm btn-block" onclick="doLogout()">Salir</button>
        </div>
    </aside>
    <main class="main" id="main"></main>
</div>

<div class="toast-box" id="toasts"></div>

<script>
// === FIREBASE INIT ===
const firebaseConfig = {
    apiKey: "AIzaSyDYPqd2EAIHBwd6F-9xupeLRnLS2dn7XYE",
    authDomain: "incidencias-mensuales-v1.firebaseapp.com",
    projectId: "incidencias-mensuales-v1",
    storageBucket: "incidencias-mensuales-v1.firebasestorage.app",
    messagingSenderId: "1078098656352",
    appId: "1:1078098656352:web:9b48069da5f244d6d59705"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function $(id){return document.getElementById(id)}
function show(id){const el=$(id);if(el)el.classList.remove('hidden')}
function hide(id){const el=$(id);if(el)el.classList.add('hidden')}
function fmt(v){return new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v||0)}
function fmtDate(d){return d?new Date(d).toLocaleDateString('es-ES'):'-'}
function toast(msg,type=''){const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=msg;$('toasts').appendChild(t);setTimeout(()=>t.remove(),4000)}
function uid(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}

const MESES=['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DIETAS={nacional_con:53.34,nacional_sin:26.67,inter_con:91.35,inter_sin:48.08};
const DIETA_LABELS={nacional_con:'Nacional c/pernocta',nacional_sin:'Nacional s/pernocta',inter_con:'Internacional c/pernocta',inter_sin:'Internacional s/pernocta'};
const DIETA_ESTADOS=['pte_pago','pagado_pte_incentivo','pagado'];
const DIETA_ESTADO_LABELS={pte_pago:'Pte. de pago',pagado_pte_incentivo:'Pagado pte. incentivo',pagado:'Pagado'};
const DIETA_ESTADO_BADGE={pte_pago:'badge-err',pagado_pte_incentivo:'badge-warn',pagado:'badge-ok'};
const HEXTRA_ESTADOS=['pendiente','pagado','disfrutado'];
const HEXTRA_BADGE={pendiente:'badge-warn',pagado:'badge-ok',disfrutado:'badge-info'};

let tiendas=[];
let empleados=[];
let comisiones=[];
let dietas=[];
let domingos=[];
let festivos=[];
let nocturnidad=[];
let objetivos=[];
let horasExtras=[];
let bonificaciones=[];
let ajustes={bonifOrdinario:450,bonifDiscontinuo:450};
let currentUser=null;

const COLLECTIONS=['tiendas','empleados','comisiones','dietas','domingos','festivos','nocturnidad','objetivos','horasExtras','bonificaciones'];

function save(key){
    const data={tiendas,empleados,comisiones,dietas,domingos,festivos,nocturnidad,objetivos,horasExtras,bonificaciones};
    const items=data[key];
    const batch=db.batch();
    const col=db.collection(key);
    items.forEach(item=>{
        batch.set(col.doc(item.id),item);
    });
    batch.commit().catch(err=>console.error('Error guardando '+key,err));
}

function saveDoc(key,item){
    db.collection(key).doc(item.id).set(item).catch(err=>console.error('Error guardando doc',err));
}

function deleteDoc(key,id){
    db.collection(key).doc(id).delete().catch(err=>console.error('Error eliminando doc',err));
}

function saveAjustes(){
    db.collection('ajustes').doc('config').set(ajustes).catch(err=>console.error('Error saving ajustes',err));
}

async function loadAllData(){
    const promises=COLLECTIONS.map(col=>db.collection(col).get());
    const snapshots=await Promise.all(promises);
    const dataMap={};
    COLLECTIONS.forEach((col,i)=>{
        dataMap[col]=[];
        snapshots[i].forEach(doc=>dataMap[col].push(doc.data()));
    });
    tiendas=dataMap.tiendas;
    empleados=dataMap.empleados;
    comisiones=dataMap.comisiones;
    dietas=dataMap.dietas;
    domingos=dataMap.domingos;
    festivos=dataMap.festivos;
    nocturnidad=dataMap.nocturnidad;
    objetivos=dataMap.objetivos;
    horasExtras=dataMap.horasExtras;
    bonificaciones=dataMap.bonificaciones;

    try{const ajustesDoc=await db.collection('ajustes').doc('config').get();if(ajustesDoc.exists)ajustes=ajustesDoc.data()}catch(e){console.error('Error loading ajustes',e)}

    if(!tiendas.length){
        tiendas=[
            {id:uid(),nombre:'Ibiza',ubicacion:'Ibiza',estado:'activa'},
            {id:uid(),nombre:'Lagasca',ubicacion:'Madrid',estado:'activa'},
            {id:uid(),nombre:'Ban√∫s',ubicacion:'Marbella',estado:'activa'}
        ];
        save('tiendas');
    }
}

// === FIREBASE AUTH ===
function showAuthErr(msg){const el=$('authErr');el.textContent=msg;el.style.display='block'}
function hideAuthErr(){$('authErr').style.display='none'}
function showRegister(){$('loginForm').style.display='none';$('registerForm').style.display='block';hideAuthErr()}
function showLogin(){$('loginForm').style.display='block';$('registerForm').style.display='none';hideAuthErr()}

async function doLogin(){
    hideAuthErr();
    const email=$('authEmail').value.trim(),pass=$('authPass').value;
    if(!email||!pass){showAuthErr('Introduce email y contrase√±a');return}
    try{await auth.signInWithEmailAndPassword(email,pass)}
    catch(e){showAuthErr(e.code==='auth/user-not-found'?'Usuario no encontrado':e.code==='auth/wrong-password'||e.code==='auth/invalid-credential'?'Contrase√±a incorrecta':'Error: '+e.message)}
}

async function doRegister(){
    hideAuthErr();
    const name=$('regName').value.trim(),email=$('regEmail').value.trim(),pass=$('regPass').value;
    if(!name||!email||!pass){showAuthErr('Rellena todos los campos');return}
    if(pass.length<6){showAuthErr('La contrase√±a debe tener al menos 6 caracteres');return}
    try{
        const cred=await auth.createUserWithEmailAndPassword(email,pass);
        await cred.user.updateProfile({displayName:name});
    }catch(e){showAuthErr(e.code==='auth/email-already-in-use'?'Este email ya est√° registrado':e.code==='auth/weak-password'?'Contrase√±a demasiado d√©bil':'Error: '+e.message)}
}

function doLogout(){auth.signOut()}

auth.onAuthStateChanged(async user=>{
    if(user){
        currentUser=user;
        show('load');
        try{
            await loadAllData();
            showApp();
        }catch(e){
            console.error('Error cargando datos',e);
            toast('Error cargando datos','err');
            hide('load');
        }
    } else {
        currentUser=null;
        $('app').classList.remove('active');
        show('authScreen');
        hide('load');
    }
});

function getObjetivo(tiendaId,mes,year){
    const o=objetivos.find(x=>x.tiendaId===tiendaId&&x.mes==mes&&x.year==year);
    return o?{obj1:o.obj1,obj2:o.obj2}:{obj1:0,obj2:0};
}

function isInternacional(tipo){return tipo==='inter_con'||tipo==='inter_sin'}

function showApp(){
    hide('authScreen');$('app').classList.add('active');
    const name=currentUser.displayName||currentUser.email.split('@')[0];
    $('uName').textContent=name;$('avatar').textContent=name[0].toUpperCase();
    $('uEmail').innerHTML=currentUser.email+'<span class="local-badge">‚òÅÔ∏è</span>';
    renderPage('dashboard');hide('load');
}

// === RENDER PAGE ===
function renderPage(page){
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active',n.dataset.p===page));
    const m=$('main'),now=new Date();
    const mesOpts=MESES.slice(1).map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');
    const tiendaOpts=tiendas.filter(t=>t.estado==='activa').map(t=>`<option value="${t.id}">${t.nombre}</option>`).join('');
    const empOpts=empleados.filter(e=>e.estado==='activo').map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
    const empAllOpts=empleados.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
    const yearOpts='<option value="2026">2026</option><option value="2025">2025</option>';

    const pages={
        dashboard:`
            <div class="page-header"><div><h1 class="page-title">Dashboard</h1><p class="page-sub">Resumen de incidencias</p></div>
            <div class="filter-bar">
                <select class="form-select" id="dEmp" onchange="updateDash()"><option value="">Todos los empleados</option>${empAllOpts}</select>
                <select class="form-select" id="dMes" onchange="updateDash()"><option value="">Todos</option>${mesOpts}</select>
                <select class="form-select" id="dYear" onchange="updateDash()"><option value="">Todos</option>${yearOpts}</select>
            </div></div>
            <div class="stats">
                <div class="stat"><div class="stat-label">Comisiones Mes</div><div class="stat-val" id="sC">0‚Ç¨</div></div>
                <div class="stat"><div class="stat-label">Comisi√≥n Anual</div><div class="stat-val" id="sCA">0‚Ç¨</div><div class="stat-sub" id="sCAdet"></div></div>
                <div class="stat"><div class="stat-label">Total Dietas</div><div class="stat-val" id="sD">0‚Ç¨</div></div>
                <div class="stat"><div class="stat-label">Domingos</div><div class="stat-val" id="sDo">0</div></div>
                <div class="stat"><div class="stat-label">Festivos</div><div class="stat-val" id="sF">0</div></div>
                <div class="stat"><div class="stat-label">H. Nocturnas</div><div class="stat-val" id="sN">0h</div></div>
                <div class="stat"><div class="stat-label">H. Extras</div><div class="stat-val" id="sHE">0h</div></div>
                <div class="stat"><div class="stat-label">Bonif. Asist.</div><div class="stat-val" id="sBon">0‚Ç¨</div></div>
            </div>
            <div class="card"><div class="card-header"><h2 class="card-title">Por Empleado</h2></div><div class="card-body"><table><thead><tr><th>Empleado</th><th>Tienda</th><th>Comisi√≥n</th><th>Dietas</th><th>Dom.</th><th>Fest.</th><th>Noct.</th><th>H.Extra</th></tr></thead><tbody id="dashTb"></tbody></table></div></div>`,

        comisiones:`
            <div class="page-header"><div><h1 class="page-title">Comisiones</h1></div><button class="btn btn-p" onclick="openModal('comisionModal')">+ Nueva</button></div>
            <div class="filter-bar"><select class="form-select" id="cFMes" onchange="renderComisiones()"><option value="">Todos</option>${mesOpts}</select><select class="form-select" id="cFYear" onchange="renderComisiones()"><option value="">Todos</option>${yearOpts}</select><select class="form-select" id="cFTienda" onchange="renderComisiones()"><option value="">Todas</option>${tiendaOpts}</select></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>Mes</th><th>Tienda</th><th>Empleado</th><th>Ventas</th><th>Objetivo</th><th>Ajustes</th><th>Comisi√≥n</th><th></th></tr></thead><tbody id="comTb"></tbody></table></div></div>`,

        comisionesAnuales:`
            <div class="page-header"><div><h1 class="page-title">Comisiones Anuales</h1><p class="page-sub">Acumulado por empleado ‚Äî Se pierde si se va sin completar contrato o sin preaviso de 15 d√≠as</p></div></div>
            <div class="filter-bar"><select class="form-select" id="caFYear" onchange="renderComisionesAnuales()">${yearOpts}</select><select class="form-select" id="caFTienda" onchange="renderComisionesAnuales()"><option value="">Todas las tiendas</option>${tiendaOpts}</select></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>Empleado</th><th>Tienda</th><th>% Anual</th><th>Ventas acumuladas</th><th>Comisi√≥n anual</th><th>Estado</th><th></th></tr></thead><tbody id="caAnualTb"></tbody></table></div></div>`,

        dietas:`
            <div class="page-header"><div><h1 class="page-title">Dietas</h1></div><button class="btn btn-p" onclick="openModal('dietaModal')">+ Nueva</button></div>
            <div class="filter-bar"><select class="form-select" id="dietFMes" onchange="renderDietas()"><option value="">Todos</option>${mesOpts}</select><select class="form-select" id="dietFEstado" onchange="renderDietas()"><option value="">Todos estados</option><option value="pte_pago">Pte. de pago</option><option value="pagado_pte_incentivo">Pagado pte. incentivo</option><option value="pagado">Pagado</option></select></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>F. Viaje</th><th>F. Pago</th><th>Empleado</th><th>Tipo</th><th>D√≠as</th><th>Dieta</th><th>Incentivo</th><th>Estado</th><th></th></tr></thead><tbody id="dietTb"></tbody></table></div></div>`,

        domingos:`
            <div class="page-header"><div><h1 class="page-title">Domingos</h1></div><button class="btn btn-p" onclick="openModal('domModal')">+ Nuevo</button></div>
            <div class="filter-bar"><select class="form-select" id="domFMes" onchange="renderDomingos()"><option value="">Todos</option>${mesOpts}</select></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>Fecha</th><th>Tienda</th><th>Empleado</th><th>Autorizado</th><th></th></tr></thead><tbody id="domTb"></tbody></table></div></div>`,

        festivos:`
            <div class="page-header"><div><h1 class="page-title">Festivos</h1></div><button class="btn btn-p" onclick="openModal('festModal')">+ Nuevo</button></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>Fecha</th><th>Festivo</th><th>Tienda</th><th>Empleado</th><th></th></tr></thead><tbody id="festTb"></tbody></table></div></div>`,

        nocturnidad:`
            <div class="page-header"><div><h1 class="page-title">Nocturnidad</h1></div><button class="btn btn-p" onclick="openModal('noctModal')">+ Nuevo</button></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>Mes</th><th>Empleado</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>S5</th><th>Total</th><th></th></tr></thead><tbody id="noctTb"></tbody></table></div></div>`,

        horasExtras:`
            <div class="page-header"><div><h1 class="page-title">Horas Extras</h1></div><button class="btn btn-p" onclick="openModal('hExtraModal')">+ Nueva</button></div>
            <div class="filter-bar"><select class="form-select" id="heFEst" onchange="renderHorasExtras()"><option value="">Todos estados</option><option value="pendiente">Pendiente</option><option value="pagado">Pagado</option><option value="disfrutado">Disfrutado</option></select></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>Fecha</th><th>Empleado</th><th>Horas</th><th>Motivo</th><th>Estado</th><th></th></tr></thead><tbody id="heTb"></tbody></table></div></div>`,

        bonificaciones:`
            <div class="page-header"><div><h1 class="page-title">Bonificaci√≥n por Asistencia</h1><p class="page-sub">Ordinario (${fmt(ajustes.bonifOrdinario)}) / Discontinuo (${fmt(ajustes.bonifDiscontinuo)}) por temporada, proporcional a d√≠as trabajados</p></div><button class="btn btn-p" onclick="openModal('bonifModal')">+ Nueva</button></div>
            <div class="filter-bar"><select class="form-select" id="bonFYear" onchange="renderBonificaciones()"><option value="">Todos</option>${yearOpts}</select></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>A√±o</th><th>Temporada</th><th>Empleado</th><th>Tipo</th><th>D√≠as trab.</th><th>D√≠as temp.</th><th>Faltas</th><th>Importe</th><th>Estado</th><th></th></tr></thead><tbody id="bonTb"></tbody></table></div></div>`,

        empleados:`
            <div class="page-header"><div><h1 class="page-title">Empleados</h1></div><button class="btn btn-p" onclick="openModal('empModal')">+ Nuevo</button></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>Nombre</th><th>Tienda</th><th>%Obj1</th><th>%Obj2</th><th>%Anual</th><th>Contrato</th><th>Bonif.</th><th>Estado</th><th></th></tr></thead><tbody id="empTb"></tbody></table></div></div>`,

        tiendas:`
            <div class="page-header"><div><h1 class="page-title">Tiendas</h1></div><button class="btn btn-p" onclick="openModal('tiendaModal')">+ Nueva</button></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>Nombre</th><th>Ubicaci√≥n</th><th>Estado</th><th></th></tr></thead><tbody id="tiendaTb"></tbody></table></div></div>`,

        objetivosPage:`
            <div class="page-header"><div><h1 class="page-title">Objetivos Mensuales</h1><p class="page-sub">Cada mes tiene su propio objetivo por tienda</p></div><button class="btn btn-p" onclick="openModal('objModal',{})">+ Nuevo Objetivo</button></div>
            <div class="filter-bar"><select class="form-select" id="objFTienda" onchange="renderObjetivosPage()"><option value="">Todas las tiendas</option>${tiendaOpts}</select><select class="form-select" id="objFYear" onchange="renderObjetivosPage()">${yearOpts}</select></div>
            <div class="card"><div class="card-body"><table><thead><tr><th>Tienda</th><th>Mes</th><th>A√±o</th><th>Objetivo 1</th><th>Objetivo 2</th><th></th></tr></thead><tbody id="objPageTb"></tbody></table></div></div>`,

        exportar:`
            <div class="page-header"><div><h1 class="page-title">Exportar</h1><p class="page-sub">Genera Excel para gestor√≠a</p></div></div>
            <div class="card"><div class="card-body"><div class="form-row"><div class="form-group"><label>Mes</label><select class="form-select" id="expMes"><option value="">Todos</option>${mesOpts}</select></div><div class="form-group"><label>A√±o</label><select class="form-select" id="expYear">${yearOpts}</select></div></div><button class="btn btn-p" onclick="exportExcel()">üì• Descargar Excel</button></div></div>`,

        ajustesPage:`
            <div class="page-header"><div><h1 class="page-title">Ajustes</h1><p class="page-sub">Configuraci√≥n general de la aplicaci√≥n</p></div></div>
            <div class="card"><div class="card-header"><h2 class="card-title">Bonificaci√≥n por Asistencia</h2></div><div class="card-body">
            <form onsubmit="saveAjustesForm(event)">
            <p style="color:var(--txt2);margin-bottom:16px">Configura el importe base por temporada (6 meses) para cada tipo de contrato</p>
            <div class="form-row"><div class="form-group"><label>Fijo Ordinario (‚Ç¨/temporada)</label><input type="number" class="form-input" id="ajBonifOrdinario" value="${ajustes.bonifOrdinario}" step="0.01" min="0" required><small style="color:var(--txt2)">Para contratos indefinidos</small></div>
            <div class="form-group"><label>Fijo Discontinuo (‚Ç¨/temporada)</label><input type="number" class="form-input" id="ajBonifDiscontinuo" value="${ajustes.bonifDiscontinuo}" step="0.01" min="0" required><small style="color:var(--txt2)">Para contratos fijos discontinuos</small></div></div>
            <button type="submit" class="btn btn-p">Guardar ajustes</button>
            </form></div></div>`
    };

    m.innerHTML=pages[page]||'<p>P√°gina no encontrada</p>';
    if(page==='dashboard'){$('dMes').value=now.getMonth()+1;$('dYear').value=now.getFullYear();updateDash()}
    if(page==='comisiones')renderComisiones();
    if(page==='comisionesAnuales')renderComisionesAnuales();
    if(page==='dietas')renderDietas();
    if(page==='domingos')renderDomingos();
    if(page==='festivos')renderFestivos();
    if(page==='nocturnidad')renderNocturnidad();
    if(page==='horasExtras')renderHorasExtras();
    if(page==='bonificaciones')renderBonificaciones();
    if(page==='empleados')renderEmpleados();
    if(page==='tiendas')renderTiendas();
    if(page==='objetivosPage')renderObjetivosPage();
    if(page==='exportar'){$('expMes').value=now.getMonth()+1;$('expYear').value=now.getFullYear()}
}

function saveAjustesForm(e){
    e.preventDefault();
    ajustes.bonifOrdinario=+$('ajBonifOrdinario').value;
    ajustes.bonifDiscontinuo=+$('ajBonifDiscontinuo').value;
    saveAjustes();
    toast('Ajustes guardados','ok');
}

function updateBonifInfo(){
    const tipo=$('mETipo')?.value,info=$('mEBonifInfo');
    if(!info)return;
    if(tipo==='indefinido')info.textContent='Fijo ordinario: '+fmt(ajustes.bonifOrdinario)+'/temporada';
    else if(tipo==='fija_discontinua')info.textContent='Fijo discontinuo: '+fmt(ajustes.bonifDiscontinuo)+'/temporada';
    else info.textContent='No aplica para contratos temporales';
}

function autoSetBonif(){
    const tipo=$('mETipo')?.value,bonifSel=$('mEBonif');
    if(bonifSel){
        if(tipo==='indefinido'||tipo==='fija_discontinua')bonifSel.value='si';
        else bonifSel.value='no';
    }
    updateBonifInfo();
}

// === DASHBOARD ===
function updateDash(){
    if(!$('dMes')||!$('dYear'))return;
    const mesVal=$('dMes').value,yearVal=$('dYear').value,empVal=$('dEmp')?.value||'';
    const mes=mesVal?+mesVal:0,year=yearVal?+yearVal:0;
    function mm(m,y){return(!mes||m==mes)&&(!year||y==year)}
    function fe(empId){return !empVal||empId===empVal}

    const cF=comisiones.filter(c=>mm(c.mes,c.year)&&fe(c.empId));
    const dF=dietas.filter(d=>{const dt=new Date(d.fechaViaje||d.fecha);return mm(dt.getMonth()+1,dt.getFullYear())&&fe(d.empId)});
    const doF=domingos.filter(d=>{const dt=new Date(d.fecha);return mm(dt.getMonth()+1,dt.getFullYear())&&fe(d.empId)});
    const nF=nocturnidad.filter(n=>mm(n.mes,n.year)&&fe(n.empId));
    const fF=festivos.filter(f=>{const dt=new Date(f.fecha);return mm(dt.getMonth()+1,dt.getFullYear())&&fe(f.empId)});
    const hF=horasExtras.filter(h=>{const dt=new Date(h.fecha);return mm(dt.getMonth()+1,dt.getFullYear())&&fe(h.empId)});

    $('sC').textContent=fmt(cF.reduce((s,c)=>s+(c.comision||0),0));
    $('sD').textContent=fmt(dF.reduce((s,d)=>s+(d.importe||0)+(d.incentivo||0),0));
    $('sDo').textContent=doF.length;
    $('sF').textContent=fF.length;
    $('sN').textContent=nF.reduce((s,n)=>s+(n.s1||0)+(n.s2||0)+(n.s3||0)+(n.s4||0)+(n.s5||0),0)+'h';
    $('sHE').textContent=hF.reduce((s,h)=>s+(h.horas||0),0)+'h';

    const bonF=bonificaciones.filter(b=>(!year||b.year==year)&&fe(b.empId));
    $('sBon').textContent=fmt(bonF.reduce((s,b)=>s+(b.importe||0),0));

    // Comision anual
    const yForAnual=year||new Date().getFullYear();
    const cAnual=comisiones.filter(c=>c.year==yForAnual&&fe(c.empId));
    const ventasAnual=cAnual.reduce((s,c)=>s+(c.ventas||0)+(c.ajustes||0),0);
    let comAnual=0;
    if(empVal){
        const emp=empleados.find(e=>e.id===empVal);
        const perdida=emp?.anualPerdido&&emp.anualPerdido[yForAnual];
        comAnual=emp&&!perdida?ventasAnual*((emp.pctAnual||0)/100):0;
    } else {
        empleados.forEach(e=>{
            const perdida=e.anualPerdido&&e.anualPerdido[yForAnual];
            if(perdida)return;
            const vc=cAnual.filter(c=>c.empId===e.id).reduce((s,c)=>s+(c.ventas||0)+(c.ajustes||0),0);
            comAnual+=vc*((e.pctAnual||0)/100);
        });
    }
    $('sCA').textContent=fmt(comAnual);
    $('sCAdet').textContent=`Ventas ${yForAnual}: ${fmt(ventasAnual)}`;

    const res={};
    const emps=empVal?empleados.filter(e=>e.id===empVal):empleados;
    emps.forEach(e=>{res[e.id]={emp:e.nombre,tienda:tiendas.find(t=>t.id===e.tiendaId)?.nombre||'-',c:0,cc:0,d:0,doo:0,f:0,n:0,he:0}});
    cF.forEach(c=>{if(res[c.empId]){res[c.empId].c+=c.comision||0;res[c.empId].cc++}});
    dF.forEach(d=>{if(res[d.empId])res[d.empId].d+=(d.importe||0)+(d.incentivo||0)});
    doF.forEach(d=>{if(res[d.empId])res[d.empId].doo++});
    fF.forEach(f=>{if(res[f.empId])res[f.empId].f++});
    nF.forEach(n=>{if(res[n.empId])res[n.empId].n+=(n.s1||0)+(n.s2||0)+(n.s3||0)+(n.s4||0)+(n.s5||0)});
    hF.forEach(h=>{if(res[h.empId])res[h.empId].he+=(h.horas||0)});

    const rows=Object.values(res).filter(r=>r.cc||r.d||r.doo||r.f||r.n||r.he);
    $('dashTb').innerHTML=rows.length?rows.map(r=>`<tr><td><b>${r.emp}</b></td><td>${r.tienda}</td><td>${fmt(r.c)}</td><td>${fmt(r.d)}</td><td>${r.doo}</td><td>${r.f}</td><td>${r.n}h</td><td>${r.he}h</td></tr>`).join(''):'<tr><td colspan="8" class="empty"><h3>Sin datos</h3><p>A√±ade empleados y registra incidencias</p></td></tr>';
}

// === RENDER TABLES ===
function renderComisiones(){
    const fMes=$('cFMes')?.value,fYear=$('cFYear')?.value,fTienda=$('cFTienda')?.value;
    let f=comisiones;
    if(fMes)f=f.filter(c=>c.mes==fMes);
    if(fYear)f=f.filter(c=>c.year==fYear);
    if(fTienda)f=f.filter(c=>c.tiendaId===fTienda);
    $('comTb').innerHTML=f.length?f.map(c=>{
        const e=empleados.find(x=>x.id===c.empId),t=tiendas.find(x=>x.id===c.tiendaId);
        return `<tr><td>${MESES[c.mes]} ${c.year}</td><td>${t?.nombre||'-'}</td><td><b>${e?.nombre||'-'}</b></td><td>${fmt(c.ventas)}</td><td><span class="badge ${c.obj==2?'badge-ok':c.obj==1?'badge-warn':'badge-info'}">Obj ${c.obj||'Base'}</span></td><td>${c.ajustes?fmt(c.ajustes):'-'}</td><td><b style="color:var(--ok)">${fmt(c.comision)}</b></td><td><div class="actions"><button class="act-btn" onclick="editCom('${c.id}')">‚úèÔ∏è</button><button class="act-btn del" onclick="delCom('${c.id}')">üóëÔ∏è</button></div></td></tr>`;
    }).join(''):'<tr><td colspan="8" class="empty"><h3>Sin registros</h3></td></tr>';
}

function renderDietas(){
    const fMes=$('dietFMes')?.value,fEst=$('dietFEstado')?.value;
    let f=dietas;
    if(fMes)f=f.filter(d=>new Date(d.fechaViaje||d.fecha).getMonth()+1==fMes);
    if(fEst)f=f.filter(d=>d.estado===fEst);
    $('dietTb').innerHTML=f.length?f.map(d=>{
        const e=empleados.find(x=>x.id===d.empId);
        return `<tr><td>${fmtDate(d.fechaViaje)}</td><td>${fmtDate(d.fecha)}</td><td><b>${e?.nombre||'-'}</b></td><td>${DIETA_LABELS[d.tipo]||d.tipo}</td><td>${d.dias}</td><td>${fmt(d.importe)}</td><td>${fmt(d.incentivo)}</td><td><span class="badge click ${DIETA_ESTADO_BADGE[d.estado]||'badge-warn'}" onclick="cycleDietaEstado('${d.id}')">${DIETA_ESTADO_LABELS[d.estado]||d.estado}</span></td><td><div class="actions"><button class="act-btn" onclick="editDiet('${d.id}')">‚úèÔ∏è</button><button class="act-btn del" onclick="delDiet('${d.id}')">üóëÔ∏è</button></div></td></tr>`;
    }).join(''):'<tr><td colspan="9" class="empty"><h3>Sin registros</h3></td></tr>';
}

function renderDomingos(){
    const fMes=$('domFMes')?.value;let f=domingos;
    if(fMes)f=f.filter(d=>new Date(d.fecha).getMonth()+1==fMes);
    $('domTb').innerHTML=f.length?f.map(d=>{
        const e=empleados.find(x=>x.id===d.empId),t=tiendas.find(x=>x.id===d.tiendaId);
        return `<tr><td>${fmtDate(d.fecha)}</td><td>${t?.nombre||'-'}</td><td><b>${e?.nombre||'-'}</b></td><td><span class="badge ${d.autorizado?'badge-ok':'badge-err'}">${d.autorizado?'S√≠':'No'}</span></td><td><div class="actions"><button class="act-btn" onclick="editDom('${d.id}')">‚úèÔ∏è</button><button class="act-btn del" onclick="delDom('${d.id}')">üóëÔ∏è</button></div></td></tr>`;
    }).join(''):'<tr><td colspan="5" class="empty"><h3>Sin registros</h3></td></tr>';
}

function renderFestivos(){
    $('festTb').innerHTML=festivos.length?festivos.map(f=>{
        const e=empleados.find(x=>x.id===f.empId),t=tiendas.find(x=>x.id===f.tiendaId);
        return `<tr><td>${fmtDate(f.fecha)}</td><td><b>${f.nombre}</b></td><td>${t?.nombre||'-'}</td><td>${e?.nombre||'-'}</td><td><div class="actions"><button class="act-btn" onclick="editFest('${f.id}')">‚úèÔ∏è</button><button class="act-btn del" onclick="delFest('${f.id}')">üóëÔ∏è</button></div></td></tr>`;
    }).join(''):'<tr><td colspan="5" class="empty"><h3>Sin registros</h3></td></tr>';
}

function renderNocturnidad(){
    $('noctTb').innerHTML=nocturnidad.length?nocturnidad.map(n=>{
        const e=empleados.find(x=>x.id===n.empId);
        const tot=(n.s1||0)+(n.s2||0)+(n.s3||0)+(n.s4||0)+(n.s5||0);
        return `<tr><td>${MESES[n.mes]} ${n.year}</td><td><b>${e?.nombre||'-'}</b></td><td>${n.s1||0}</td><td>${n.s2||0}</td><td>${n.s3||0}</td><td>${n.s4||0}</td><td>${n.s5||0}</td><td><b>${tot}h</b></td><td><div class="actions"><button class="act-btn" onclick="editNoct('${n.id}')">‚úèÔ∏è</button><button class="act-btn del" onclick="delNoct('${n.id}')">üóëÔ∏è</button></div></td></tr>`;
    }).join(''):'<tr><td colspan="9" class="empty"><h3>Sin registros</h3></td></tr>';
}

function renderHorasExtras(){
    const fEst=$('heFEst')?.value;let f=horasExtras;
    if(fEst)f=f.filter(h=>h.estado===fEst);
    $('heTb').innerHTML=f.length?f.map(h=>{
        const e=empleados.find(x=>x.id===h.empId);
        return `<tr><td>${fmtDate(h.fecha)}</td><td><b>${e?.nombre||'-'}</b></td><td>${h.horas}h</td><td>${h.motivo||'-'}</td><td><span class="badge click ${HEXTRA_BADGE[h.estado]||'badge-warn'}" onclick="cycleHExtraEstado('${h.id}')">${h.estado}</span></td><td><div class="actions"><button class="act-btn" onclick="editHExtra('${h.id}')">‚úèÔ∏è</button><button class="act-btn del" onclick="delHExtra('${h.id}')">üóëÔ∏è</button></div></td></tr>`;
    }).join(''):'<tr><td colspan="6" class="empty"><h3>Sin registros</h3></td></tr>';
}

function renderEmpleados(){
    $('empTb').innerHTML=empleados.length?empleados.map(e=>{
        const t=tiendas.find(x=>x.id===e.tiendaId);
        const tipoLabel={'indefinido':'Indef.','fija_discontinua':'Fija disc.','temporal':'Temporal'};
        return `<tr><td><b>${e.nombre}</b></td><td>${t?.nombre||'-'}</td><td>${e.obj1}%</td><td>${e.obj2}%</td><td>${e.pctAnual||0}%</td><td>${tipoLabel[e.tipoContrato]||'Indef.'}</td><td>${e.bonifAsistencia==='si'?(e.tipoContrato==='fija_discontinua'?'<span class="badge badge-ok">Disc.</span>':'<span class="badge badge-ok">Ord.</span>'):'‚Äî'}</td><td><span class="badge ${e.estado==='activo'?'badge-ok':'badge-err'}">${e.estado}</span></td><td><div class="actions"><button class="act-btn" onclick="editEmp('${e.id}')">‚úèÔ∏è</button><button class="act-btn del" onclick="delEmp('${e.id}')">üóëÔ∏è</button></div></td></tr>`;
    }).join(''):'<tr><td colspan="9" class="empty"><h3>Sin empleados</h3><p>A√±ade empleados para registrar incidencias</p></td></tr>';
}

function renderTiendas(){
    $('tiendaTb').innerHTML=tiendas.map(t=>{
        return `<tr><td><b>${t.nombre}</b></td><td>${t.ubicacion||'-'}</td><td><span class="badge ${t.estado==='activa'?'badge-ok':'badge-err'}">${t.estado}</span></td><td><div class="actions"><button class="act-btn" onclick="editTienda('${t.id}')">‚úèÔ∏è</button><button class="act-btn del" onclick="delTienda('${t.id}')">üóëÔ∏è</button></div></td></tr>`;
    }).join('');
}

function renderObjetivosPage(){
    const fTienda=$('objFTienda')?.value,fYear=$('objFYear')?.value;
    let f=objetivos.slice().sort((a,b)=>b.year-a.year||b.mes-a.mes);
    if(fTienda)f=f.filter(o=>o.tiendaId===fTienda);
    if(fYear)f=f.filter(o=>o.year==fYear);
    $('objPageTb').innerHTML=f.length?f.map(o=>{
        const t=tiendas.find(x=>x.id===o.tiendaId);
        return `<tr><td><b>${t?.nombre||'-'}</b></td><td>${MESES[o.mes]}</td><td>${o.year}</td><td>${fmt(o.obj1)}</td><td>${fmt(o.obj2)}</td><td><div class="actions"><button class="act-btn" onclick="editObj('${o.id}')">‚úèÔ∏è</button><button class="act-btn del" onclick="delObj('${o.id}')">üóëÔ∏è</button></div></td></tr>`;
    }).join(''):'<tr><td colspan="6" class="empty"><h3>Sin objetivos</h3><p>A√±ade objetivos mensuales para cada tienda</p></td></tr>';
}

// === QUICK STATE CHANGE ===
function cycleDietaEstado(id){
    const d=dietas.find(x=>x.id===id);if(!d)return;
    const i=DIETA_ESTADOS.indexOf(d.estado);
    d.estado=DIETA_ESTADOS[(i+1)%DIETA_ESTADOS.length];
    saveDoc('dietas',d);renderDietas();toast('Estado actualizado','ok');
}
function cycleHExtraEstado(id){
    const h=horasExtras.find(x=>x.id===id);if(!h)return;
    const i=HEXTRA_ESTADOS.indexOf(h.estado);
    h.estado=HEXTRA_ESTADOS[(i+1)%HEXTRA_ESTADOS.length];
    saveDoc('horasExtras',h);renderHorasExtras();toast('Estado actualizado','ok');
}

// === MODALS ===
function openModal(type,data={}){
    const now=new Date();
    if(!data.id){if(!data.mes)data.mes=now.getMonth()+1;if(!data.year)data.year=now.getFullYear();if(!data.fecha)data.fecha=now.toISOString().split('T')[0];if(!data.fechaViaje)data.fechaViaje=''}
    const tiendaOpts=tiendas.filter(t=>t.estado==='activa').map(t=>`<option value="${t.id}"${data.tiendaId===t.id?' selected':''}>${t.nombre}</option>`).join('');
    const empOpts=empleados.filter(e=>e.estado==='activo').map(e=>`<option value="${e.id}"${data.empId===e.id?' selected':''}>${e.nombre}</option>`).join('');
    const mesOpts=MESES.slice(1).map((m,i)=>`<option value="${i+1}"${data.mes==i+1?' selected':''}>${m}</option>`).join('');
    const yearOpts=`<option value="2026"${data.year==2026?' selected':''}>2026</option><option value="2025"${data.year==2025?' selected':''}>2025</option>`;

    const modals={
        tiendaModal:`<div class="modal-header"><h3 class="modal-title">${data.id?'Editar':'Nueva'} Tienda</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form onsubmit="saveTienda(event,'${data.id||''}')"><div class="modal-body">
            <div class="form-group"><label>Nombre</label><input class="form-input" id="mTNombre" value="${data.nombre||''}" required></div>
            <div class="form-group"><label>Ubicaci√≥n</label><input class="form-input" id="mTUbi" value="${data.ubicacion||''}"></div>
            <div class="form-group"><label>Estado</label><select class="form-select" id="mTEstado"><option value="activa"${data.estado==='activa'?' selected':''}>Activa</option><option value="inactiva"${data.estado==='inactiva'?' selected':''}>Inactiva</option></select></div>
            </div><div class="modal-footer"><button type="button" class="btn btn-s" onclick="closeModal()">Cancelar</button><button type="submit" class="btn btn-p">Guardar</button></div></form>`,

        objModal:`<div class="modal-header"><h3 class="modal-title">${data.id?'Editar':'Nuevo'} Objetivo Mensual</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form onsubmit="saveObj(event,'${data.id||''}')"><div class="modal-body">
            <div class="form-group"><label>Tienda</label><select class="form-select" id="mOTienda" required>${tiendas.filter(t=>t.estado==='activa').map(t=>`<option value="${t.id}"${data.tiendaId===t.id?' selected':''}>${t.nombre}</option>`).join('')}</select></div>
            <div class="form-row"><div class="form-group"><label>Mes</label><select class="form-select" id="mOMes">${mesOpts}</select></div><div class="form-group"><label>A√±o</label><select class="form-select" id="mOYear">${yearOpts}</select></div></div>
            <div class="form-row"><div class="form-group"><label>Objetivo 1 (‚Ç¨)</label><input type="number" class="form-input" id="mOObj1" value="${data.obj1||0}" step="0.01" required oninput="$('mOObj2').value=Math.round(this.value*1.3*100)/100"></div>
            <div class="form-group"><label>Objetivo 2 (‚Ç¨) ‚Äî auto: Obj1 √ó 1.30</label><input type="number" class="form-input" id="mOObj2" value="${data.obj2||Math.round((data.obj1||0)*1.3*100)/100}" step="0.01" required style="background:var(--sec);color:var(--txt2)" readonly></div></div>
            </div><div class="modal-footer"><button type="button" class="btn btn-s" onclick="closeModal()">Cancelar</button><button type="submit" class="btn btn-p">Guardar</button></div></form>`,

        empModal:`<div class="modal-header"><h3 class="modal-title">${data.id?'Editar':'Nuevo'} Empleado</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form onsubmit="saveEmp(event,'${data.id||''}')"><div class="modal-body">
            <div class="form-group"><label>Nombre</label><input class="form-input" id="mENombre" value="${data.nombre||''}" required></div>
            <div class="form-group"><label>Tienda</label><select class="form-select" id="mETienda" required>${tiendaOpts}</select></div>
            <div class="form-row"><div class="form-group"><label>% Comisi√≥n Obj.1</label><input type="number" class="form-input" id="mEObj1" value="${data.obj1||0.2}" step="0.001" required><small style="color:var(--txt2)">Se aplica siempre</small></div>
            <div class="form-group"><label>% Comisi√≥n Obj.2</label><input type="number" class="form-input" id="mEObj2" value="${data.obj2||0.25}" step="0.001" required><small style="color:var(--txt2)">Solo si alcanza objetivo</small></div></div>
            <div class="form-row"><div class="form-group"><label>% Comisi√≥n Anual</label><input type="number" class="form-input" id="mEAnual" value="${data.pctAnual||0}" step="0.001" required><small style="color:var(--txt2)">Sobre ventas anuales</small></div>
            <div class="form-group"><label>Tipo contrato</label><select class="form-select" id="mETipo" onchange="autoSetBonif()"><option value="indefinido"${data.tipoContrato==='indefinido'||!data.tipoContrato?' selected':''}>Indefinido</option><option value="fija_discontinua"${data.tipoContrato==='fija_discontinua'?' selected':''}>Fija discontinua</option><option value="temporal"${data.tipoContrato==='temporal'?' selected':''}>Temporal</option></select></div></div>
            <div class="form-row"><div class="form-group"><label>Estado</label><select class="form-select" id="mEEstado"><option value="activo"${data.estado==='activo'?' selected':''}>Activo</option><option value="baja"${data.estado==='baja'?' selected':''}>Baja</option></select></div>
            <div class="form-group"><label>Bonif. asistencia</label><select class="form-select" id="mEBonif"><option value="no"${data.bonifAsistencia!=='si'?' selected':''}>No aplica</option><option value="si"${data.bonifAsistencia==='si'?' selected':''}>S√≠</option></select><small id="mEBonifInfo" style="color:var(--txt2)"></small></div></div>
            </div><div class="modal-footer"><button type="button" class="btn btn-s" onclick="closeModal()">Cancelar</button><button type="submit" class="btn btn-p">Guardar</button></div></form>`,

        comisionModal:`<div class="modal-header"><h3 class="modal-title">${data.id?'Editar':'Nueva'} Comisi√≥n</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form onsubmit="saveCom(event,'${data.id||''}')"><div class="modal-body">
            <div class="form-row"><div class="form-group"><label>Mes</label><select class="form-select" id="mCMes" onchange="calcCom()">${mesOpts}</select></div><div class="form-group"><label>A√±o</label><select class="form-select" id="mCYear" onchange="calcCom()">${yearOpts}</select></div></div>
            <div class="form-row"><div class="form-group"><label>Tienda</label><select class="form-select" id="mCTienda" required onchange="calcCom()">${tiendaOpts}</select></div><div class="form-group"><label>Empleado</label><select class="form-select" id="mCEmp" required onchange="calcCom()">${empOpts}</select></div></div>
            <div class="form-row"><div class="form-group"><label>Ventas Tienda (‚Ç¨)</label><input type="number" class="form-input" id="mCVentas" value="${data.ventas||0}" step="0.01" required oninput="calcCom()"></div><div class="form-group"><label>Ajustes (‚Ç¨)</label><input type="number" class="form-input" id="mCAjustes" value="${data.ajustes||0}" step="0.01" oninput="calcCom()"></div></div>
            <div class="calc-box"><div class="calc-row"><span class="calc-label">Objetivo:</span><span class="calc-val" id="mCObjCalc">-</span></div><div class="calc-row"><span class="calc-label">Comisi√≥n:</span><span class="calc-val hi" id="mCComCalc">0‚Ç¨</span></div></div>
            </div><div class="modal-footer"><button type="button" class="btn btn-s" onclick="closeModal()">Cancelar</button><button type="submit" class="btn btn-p">Guardar</button></div></form>`,

        dietaModal:`<div class="modal-header"><h3 class="modal-title">${data.id?'Editar':'Nueva'} Dieta</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form onsubmit="saveDiet(event,'${data.id||''}')"><div class="modal-body">
            <div class="form-row"><div class="form-group"><label>Fecha Viaje</label><input type="date" class="form-input" id="mDFechaViaje" value="${data.fechaViaje||''}" required></div><div class="form-group"><label>Fecha Pago</label><input type="date" class="form-input" id="mDFecha" value="${data.fecha||''}" required></div></div>
            <div class="form-group"><label>Empleado</label><select class="form-select" id="mDEmp" required>${empOpts}</select></div>
            <div class="form-row"><div class="form-group"><label>Tipo</label><select class="form-select" id="mDTipo" onchange="calcDiet()"><option value="nacional_con"${data.tipo==='nacional_con'?' selected':''}>Nacional c/pernocta (53.34‚Ç¨)</option><option value="nacional_sin"${data.tipo==='nacional_sin'?' selected':''}>Nacional s/pernocta (26.67‚Ç¨)</option><option value="inter_con"${data.tipo==='inter_con'?' selected':''}>Internacional c/pernocta (91.35‚Ç¨)</option><option value="inter_sin"${data.tipo==='inter_sin'?' selected':''}>Internacional s/pernocta (48.08‚Ç¨)</option></select></div><div class="form-group"><label>D√≠as</label><input type="number" class="form-input" id="mDDias" value="${data.dias||1}" min="1" required oninput="calcDiet()"></div></div>
            <div class="form-row"><div class="form-group"><label>Incentivo (‚Ç¨)</label><input type="number" class="form-input" id="mDInc" value="${data.incentivo!=null?data.incentivo:''}" step="0.01" oninput="calcDiet()"></div><div class="form-group"><label>Estado</label><select class="form-select" id="mDEstado"><option value="pte_pago"${data.estado==='pte_pago'?' selected':''}>Pte. de pago</option><option value="pagado_pte_incentivo"${data.estado==='pagado_pte_incentivo'?' selected':''}>Pagado pte. incentivo</option><option value="pagado"${data.estado==='pagado'?' selected':''}>Pagado</option></select></div></div>
            <div class="form-group"><label>Motivo</label><input class="form-input" id="mDMotivo" value="${data.motivo||''}"></div>
            <div class="calc-box"><div class="calc-row"><span class="calc-label">Dieta:</span><span class="calc-val" id="mDDietCalc">0‚Ç¨</span></div><div class="calc-row"><span class="calc-label">Incentivo:</span><span class="calc-val" id="mDIncCalc">0‚Ç¨</span></div><div class="calc-row"><span class="calc-label">Total:</span><span class="calc-val hi" id="mDTotCalc">0‚Ç¨</span></div></div>
            </div><div class="modal-footer"><button type="button" class="btn btn-s" onclick="closeModal()">Cancelar</button><button type="submit" class="btn btn-p">Guardar</button></div></form>`,

        domModal:`<div class="modal-header"><h3 class="modal-title">${data.id?'Editar':'Nuevo'} Domingo</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form onsubmit="saveDom(event,'${data.id||''}')"><div class="modal-body">
            <div class="form-row"><div class="form-group"><label>Fecha</label><input type="date" class="form-input" id="mDoFecha" value="${data.fecha||''}" required></div><div class="form-group"><label>Tienda</label><select class="form-select" id="mDoTienda" required>${tiendaOpts}</select></div></div>
            <div class="form-row"><div class="form-group"><label>Empleado</label><select class="form-select" id="mDoEmp" required>${empOpts}</select></div><div class="form-group"><label>¬øAutorizado CCAA?</label><select class="form-select" id="mDoAut"><option value="true"${data.autorizado?' selected':''}>S√≠</option><option value="false"${data.autorizado===false?' selected':''}>No</option></select></div></div>
            </div><div class="modal-footer"><button type="button" class="btn btn-s" onclick="closeModal()">Cancelar</button><button type="submit" class="btn btn-p">Guardar</button></div></form>`,

        festModal:`<div class="modal-header"><h3 class="modal-title">${data.id?'Editar':'Nuevo'} Festivo</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form onsubmit="saveFest(event,'${data.id||''}')"><div class="modal-body">
            <div class="form-row"><div class="form-group"><label>Fecha</label><input type="date" class="form-input" id="mFFecha" value="${data.fecha||''}" required></div><div class="form-group"><label>Nombre Festivo</label><input class="form-input" id="mFNombre" value="${data.nombre||''}" required></div></div>
            <div class="form-row"><div class="form-group"><label>Tienda</label><select class="form-select" id="mFTienda" required>${tiendaOpts}</select></div><div class="form-group"><label>Empleado</label><select class="form-select" id="mFEmp" required>${empOpts}</select></div></div>
            </div><div class="modal-footer"><button type="button" class="btn btn-s" onclick="closeModal()">Cancelar</button><button type="submit" class="btn btn-p">Guardar</button></div></form>`,

        noctModal:`<div class="modal-header"><h3 class="modal-title">${data.id?'Editar':'Nueva'} Nocturnidad</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form onsubmit="saveNoct(event,'${data.id||''}')"><div class="modal-body">
            <div class="form-row"><div class="form-group"><label>Mes</label><select class="form-select" id="mNMes">${mesOpts}</select></div><div class="form-group"><label>A√±o</label><select class="form-select" id="mNYear">${yearOpts}</select></div></div>
            <div class="form-group"><label>Empleado</label><select class="form-select" id="mNEmp" required>${empOpts}</select></div>
            <div class="form-row"><div class="form-group"><label>Semana 1</label><input type="number" class="form-input" id="mNS1" value="${data.s1||0}" step="0.5" min="0"></div><div class="form-group"><label>Semana 2</label><input type="number" class="form-input" id="mNS2" value="${data.s2||0}" step="0.5" min="0"></div></div>
            <div class="form-row"><div class="form-group"><label>Semana 3</label><input type="number" class="form-input" id="mNS3" value="${data.s3||0}" step="0.5" min="0"></div><div class="form-group"><label>Semana 4</label><input type="number" class="form-input" id="mNS4" value="${data.s4||0}" step="0.5" min="0"></div></div>
            <div class="form-group"><label>Semana 5</label><input type="number" class="form-input" id="mNS5" value="${data.s5||0}" step="0.5" min="0"></div>
            </div><div class="modal-footer"><button type="button" class="btn btn-s" onclick="closeModal()">Cancelar</button><button type="submit" class="btn btn-p">Guardar</button></div></form>`,

        hExtraModal:`<div class="modal-header"><h3 class="modal-title">${data.id?'Editar':'Nueva'} Hora Extra</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form onsubmit="saveHExtra(event,'${data.id||''}')"><div class="modal-body">
            <div class="form-row"><div class="form-group"><label>Fecha</label><input type="date" class="form-input" id="mHFecha" value="${data.fecha||''}" required></div><div class="form-group"><label>Empleado</label><select class="form-select" id="mHEmp" required>${empOpts}</select></div></div>
            <div class="form-row"><div class="form-group"><label>Horas</label><input type="number" class="form-input" id="mHHoras" value="${data.horas||0}" step="0.5" min="0.5" required></div><div class="form-group"><label>Estado</label><select class="form-select" id="mHEstado"><option value="pendiente"${data.estado==='pendiente'||!data.estado?' selected':''}>Pendiente</option><option value="pagado"${data.estado==='pagado'?' selected':''}>Pagado</option><option value="disfrutado"${data.estado==='disfrutado'?' selected':''}>Disfrutado</option></select></div></div>
            <div class="form-group"><label>Motivo</label><input class="form-input" id="mHMotivo" value="${data.motivo||''}" required></div>
            </div><div class="modal-footer"><button type="button" class="btn btn-s" onclick="closeModal()">Cancelar</button><button type="submit" class="btn btn-p">Guardar</button></div></form>`,

        bonifModal:(()=>{const bEmpOpts=empleados.filter(e=>e.estado==='activo'&&e.bonifAsistencia==='si').map(e=>`<option value="${e.id}"${data.empId===e.id?' selected':''}>${e.nombre} (${e.tipoContrato==='fija_discontinua'?'Disc.':'Ord.'})</option>`).join('');return `<div class="modal-header"><h3 class="modal-title">${data.id?'Editar':'Nueva'} Bonificaci√≥n Asistencia</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form onsubmit="saveBonif(event,'${data.id||''}')"><div class="modal-body">
            <div class="form-row"><div class="form-group"><label>A√±o</label><select class="form-select" id="mBYear">${yearOpts}</select></div><div class="form-group"><label>Temporada</label><select class="form-select" id="mBTemp"><option value="verano"${data.temporada==='verano'||!data.temporada?' selected':''}>Verano (abr-sep)</option><option value="invierno"${data.temporada==='invierno'?' selected':''}>Invierno (oct-mar)</option></select></div></div>
            <div class="form-group"><label>Empleado</label><select class="form-select" id="mBEmp" required onchange="calcBonif()">${bEmpOpts||'<option value="">‚Äî Sin empleados con bonif. ‚Äî</option>'}</select></div>
            <div class="form-row"><div class="form-group"><label>D√≠as trabajados</label><input type="number" class="form-input" id="mBDias" value="${data.diasTrabajados||0}" min="0" required oninput="calcBonif()"></div><div class="form-group"><label>D√≠as temporada (total)</label><input type="number" class="form-input" id="mBDiasTemp" value="${data.diasTemporada||182}" min="1" required oninput="calcBonif()"></div></div>
            <div class="form-group"><label>Faltas (d√≠as no trabajados sin justificar)</label><input type="number" class="form-input" id="mBFaltas" value="${data.faltas||0}" min="0" oninput="calcBonif()"></div>
            <div class="form-group"><label>Estado</label><select class="form-select" id="mBEstado"><option value="pendiente"${data.estado==='pendiente'||!data.estado?' selected':''}>Pendiente</option><option value="pagado"${data.estado==='pagado'?' selected':''}>Pagado</option></select></div>
            <div class="calc-box"><div class="calc-row"><span class="calc-label">Base temporada:</span><span class="calc-val" id="mBBaseCalc">0‚Ç¨</span></div><div class="calc-row"><span class="calc-label">Proporcional (d√≠as):</span><span class="calc-val" id="mBCalc">0‚Ç¨</span></div><div class="calc-row"><span class="calc-label">Faltas descuento:</span><span class="calc-val" id="mBDescCalc">0‚Ç¨</span></div><div class="calc-row"><span class="calc-label">Total:</span><span class="calc-val hi" id="mBTotCalc">0‚Ç¨</span></div></div>
            </div><div class="modal-footer"><button type="button" class="btn btn-s" onclick="closeModal()">Cancelar</button><button type="submit" class="btn btn-p">Guardar</button></div></form>`;})()
    };

    let overlay=document.querySelector('.modal-bg');
    if(!overlay){overlay=document.createElement('div');overlay.className='modal-bg';overlay.onclick=e=>{if(e.target===overlay)closeModal()};document.body.appendChild(overlay)}
    overlay.innerHTML=`<div class="modal">${modals[type]||''}</div>`;
    overlay.classList.add('active');
    if(type==='comisionModal')setTimeout(calcCom,0);
    if(type==='dietaModal')setTimeout(calcDiet,0);
    if(type==='bonifModal')setTimeout(calcBonif,0);
    if(type==='empModal'){const isNew=!data.id;setTimeout(()=>{if(isNew)autoSetBonif();else updateBonifInfo()},0)}
}
function closeModal(){document.querySelector('.modal-bg')?.classList.remove('active')}

// === CALCULATIONS ===
function calcCom(){
    const empId=$('mCEmp')?.value,tiendaId=$('mCTienda')?.value,ventas=+($('mCVentas')?.value||0),ajustes=+($('mCAjustes')?.value||0);
    const mes=+($('mCMes')?.value||0),year=+($('mCYear')?.value||0);
    const emp=empleados.find(e=>e.id===empId),tienda=tiendas.find(t=>t.id===tiendaId);
    if(!emp||!tienda){$('mCObjCalc').textContent='Selecciona empleado y tienda';$('mCComCalc').textContent='0‚Ç¨';return}
    const neto=ventas+ajustes;
    const {obj1,obj2}=getObjetivo(tiendaId,mes,year);
    let objLvl=1,pct=emp.obj1;
    if(neto>=obj2){objLvl=2;pct=emp.obj2}
    const com=Math.max(0,neto*(pct/100));
    $('mCObjCalc').textContent=objLvl===2?`Objetivo 2 (${pct}%)`:`Obj.1 (${pct}%) ‚Äî Obj2: ${fmt(obj2)}`;
    $('mCComCalc').textContent=fmt(com);
}

function calcDiet(){
    const tipo=$('mDTipo')?.value,dias=+($('mDDias')?.value||0);
    let inc=+($('mDInc')?.value||0);
    if($('mDInc')?.value===''&&isInternacional(tipo)){inc=20*dias;$('mDInc').value=inc}
    const tarifa=DIETAS[tipo]||0,importe=tarifa*dias;
    $('mDDietCalc').textContent=fmt(importe);
    $('mDIncCalc').textContent=fmt(inc);
    $('mDTotCalc').textContent=fmt(importe+inc);
}

function getBonifBase(empId){
    const emp=empleados.find(e=>e.id===empId);
    return emp&&emp.tipoContrato==='fija_discontinua'?ajustes.bonifDiscontinuo:ajustes.bonifOrdinario;
}

function calcBonif(){
    const empId=$('mBEmp')?.value;
    const base=getBonifBase(empId);
    const dias=+($('mBDias')?.value||0),diasTemp=+($('mBDiasTemp')?.value||182),faltas=+($('mBFaltas')?.value||0);
    const proporcional=diasTemp>0?Math.round((base*dias/diasTemp)*100)/100:0;
    const descuento=diasTemp>0?Math.round((base*faltas/diasTemp)*100)/100:0;
    const total=Math.max(0,proporcional-descuento);
    if($('mBBaseCalc'))$('mBBaseCalc').textContent=fmt(base);
    $('mBCalc').textContent=fmt(proporcional);
    $('mBDescCalc').textContent=fmt(descuento);
    $('mBTotCalc').textContent=fmt(total);
}

function renderComisionesAnuales(){
    const year=+($('caFYear')?.value||new Date().getFullYear()),fTienda=$('caFTienda')?.value;
    const cYear=comisiones.filter(c=>c.year==year);
    let emps=empleados;
    if(fTienda)emps=emps.filter(e=>e.tiendaId===fTienda);
    const rows=emps.filter(e=>e.pctAnual>0).map(e=>{
        const t=tiendas.find(x=>x.id===e.tiendaId);
        const ventas=cYear.filter(c=>c.empId===e.id).reduce((s,c)=>s+(c.ventas||0)+(c.ajustes||0),0);
        const comAnual=Math.round(ventas*(e.pctAnual/100)*100)/100;
        const perdida=e.anualPerdido&&e.anualPerdido[year];
        const motivoPerdida=perdida||'';
        const estado=perdida?'<span class="badge badge-err">Perdida</span>':e.estado==='baja'?'<span class="badge badge-warn">Baja</span>':'<span class="badge badge-ok">Activo</span>';
        return `<tr><td><b>${e.nombre}</b></td><td>${t?.nombre||'-'}</td><td>${e.pctAnual}%</td><td>${fmt(ventas)}</td><td><b style="color:${perdida?'var(--err)':'var(--ok)'}">${perdida?'<s>'+fmt(comAnual)+'</s> 0‚Ç¨':fmt(comAnual)}</b></td><td>${estado}${motivoPerdida?' <small style="color:var(--txt2)">('+motivoPerdida+')</small>':''}</td><td><div class="actions">${!perdida?`<button class="act-btn del" title="Marcar como perdida" onclick="marcarAnualPerdido('${e.id}',${year})">‚ùå</button>`:`<button class="act-btn" title="Restaurar" onclick="restaurarAnual('${e.id}',${year})">‚Ü©Ô∏è</button>`}</div></td></tr>`;
    });
    $('caAnualTb').innerHTML=rows.length?rows.join(''):'<tr><td colspan="7" class="empty"><h3>Sin datos</h3><p>No hay empleados con % anual configurado o sin comisiones en este a√±o</p></td></tr>';
}

function marcarAnualPerdido(empId,year){
    const motivo=prompt('Motivo de p√©rdida de comisi√≥n anual:\\n- Baja sin preaviso 15 d√≠as\\n- No complet√≥ contrato\\n- Otro motivo','Baja sin preaviso 15 d√≠as');
    if(!motivo)return;
    const emp=empleados.find(e=>e.id===empId);if(!emp)return;
    if(!emp.anualPerdido)emp.anualPerdido={};
    emp.anualPerdido[year]=motivo;
    saveDoc('empleados',emp);renderComisionesAnuales();toast('Comisi√≥n anual marcada como perdida','err');
}

function restaurarAnual(empId,year){
    const emp=empleados.find(e=>e.id===empId);if(!emp||!emp.anualPerdido)return;
    delete emp.anualPerdido[year];
    saveDoc('empleados',emp);renderComisionesAnuales();toast('Comisi√≥n anual restaurada','ok');
}

function renderBonificaciones(){
    const fYear=$('bonFYear')?.value;
    let f=bonificaciones;
    if(fYear)f=f.filter(b=>b.year==fYear);
    $('bonTb').innerHTML=f.length?f.map(b=>{
        const e=empleados.find(x=>x.id===b.empId);
        const tipoB=e?.tipoContrato==='fija_discontinua'?'Disc.':'Ord.';
        return `<tr><td>${b.year}</td><td>${b.temporada==='verano'?'Verano (abr-sep)':'Invierno (oct-mar)'}</td><td><b>${e?.nombre||'-'}</b></td><td><span class="badge ${e?.tipoContrato==='fija_discontinua'?'badge-info':'badge-warn'}">${tipoB}</span></td><td>${b.diasTrabajados}</td><td>${b.diasTemporada}</td><td>${b.faltas||0}</td><td><b style="color:var(--ok)">${fmt(b.importe)}</b></td><td><span class="badge click ${b.estado==='pagado'?'badge-ok':'badge-warn'}" onclick="cycleBonifEstado('${b.id}')">${b.estado}</span></td><td><div class="actions"><button class="act-btn" onclick="editBonif('${b.id}')">‚úèÔ∏è</button><button class="act-btn del" onclick="delBonif('${b.id}')">üóëÔ∏è</button></div></td></tr>`;
    }).join(''):'<tr><td colspan="10" class="empty"><h3>Sin registros</h3><p>A√±ade bonificaciones para empleados con bonificaci√≥n por asistencia</p></td></tr>';
}

function cycleBonifEstado(id){
    const b=bonificaciones.find(x=>x.id===id);if(!b)return;
    b.estado=b.estado==='pendiente'?'pagado':'pendiente';
    saveDoc('bonificaciones',b);renderBonificaciones();toast('Estado actualizado','ok');
}

// === SAVE FUNCTIONS ===
function saveTienda(e,id){
    e.preventDefault();
    const data={id:id||uid(),nombre:$('mTNombre').value,ubicacion:$('mTUbi').value,estado:$('mTEstado').value};
    if(id){const idx=tiendas.findIndex(t=>t.id===id);tiendas[idx]=data}else tiendas.push(data);
    saveDoc('tiendas',data);closeModal();renderTiendas();toast('Tienda guardada','ok');
}

function saveObj(e,id){
    e.preventDefault();
    const tiendaId=$('mOTienda').value,mes=+$('mOMes').value,year=+$('mOYear').value;
    const obj1=+$('mOObj1').value,obj2=Math.round(obj1*1.3*100)/100;
    const existing=id?objetivos.findIndex(o=>o.id===id):objetivos.findIndex(o=>o.tiendaId===tiendaId&&o.mes===mes&&o.year===year);
    const data={id:existing>=0?objetivos[existing].id:uid(),tiendaId,mes,year,obj1,obj2};
    if(existing>=0)objetivos[existing]=data;else objetivos.push(data);
    saveDoc('objetivos',data);closeModal();if($('objPageTb'))renderObjetivosPage();toast('Objetivo guardado','ok');
}

function saveEmp(e,id){
    e.preventDefault();
    const data={id:id||uid(),nombre:$('mENombre').value,tiendaId:$('mETienda').value,obj1:+$('mEObj1').value,obj2:+$('mEObj2').value,pctAnual:+$('mEAnual').value,tipoContrato:$('mETipo').value,bonifAsistencia:$('mEBonif').value,estado:$('mEEstado').value};
    if(id){const existing=empleados.find(x=>x.id===id);if(existing&&existing.anualPerdido)data.anualPerdido=existing.anualPerdido;const idx=empleados.findIndex(x=>x.id===id);empleados[idx]=data}else empleados.push(data);
    saveDoc('empleados',data);closeModal();renderEmpleados();toast('Empleado guardado','ok');
}

function saveCom(e,id){
    e.preventDefault();
    const empId=$('mCEmp').value,tiendaId=$('mCTienda').value,ventas=+$('mCVentas').value,ajustes=+$('mCAjustes').value;
    const emp=empleados.find(x=>x.id===empId),tienda=tiendas.find(x=>x.id===tiendaId);
    const mes=+$('mCMes').value,year=+$('mCYear').value;
    const neto=ventas+ajustes;
    const {obj1,obj2}=getObjetivo(tiendaId,mes,year);
    let objLvl=1,pct=emp.obj1;
    if(neto>=obj2){objLvl=2;pct=emp.obj2}
    const data={id:id||uid(),mes,year,tiendaId,empId,ventas,ajustes,obj:objLvl,pct,comision:Math.max(0,neto*(pct/100))};
    if(id){const idx=comisiones.findIndex(x=>x.id===id);comisiones[idx]=data}else comisiones.push(data);
    saveDoc('comisiones',data);closeModal();renderComisiones();updateDash();toast('Comisi√≥n guardada','ok');
}

function saveDiet(e,id){
    e.preventDefault();
    const tipo=$('mDTipo').value,dias=+$('mDDias').value,inc=+$('mDInc').value;
    const data={id:id||uid(),fechaViaje:$('mDFechaViaje').value,fecha:$('mDFecha').value,empId:$('mDEmp').value,tipo,dias,importe:DIETAS[tipo]*dias,incentivo:inc,motivo:$('mDMotivo').value,estado:$('mDEstado').value};
    if(id){const idx=dietas.findIndex(x=>x.id===id);dietas[idx]=data}else dietas.push(data);
    saveDoc('dietas',data);closeModal();renderDietas();updateDash();toast('Dieta guardada','ok');
}

function saveDom(e,id){
    e.preventDefault();
    const data={id:id||uid(),fecha:$('mDoFecha').value,tiendaId:$('mDoTienda').value,empId:$('mDoEmp').value,autorizado:$('mDoAut').value==='true'};
    if(id){const idx=domingos.findIndex(x=>x.id===id);domingos[idx]=data}else domingos.push(data);
    saveDoc('domingos',data);closeModal();renderDomingos();updateDash();toast('Domingo guardado','ok');
}

function saveFest(e,id){
    e.preventDefault();
    const data={id:id||uid(),fecha:$('mFFecha').value,nombre:$('mFNombre').value,tiendaId:$('mFTienda').value,empId:$('mFEmp').value};
    if(id){const idx=festivos.findIndex(x=>x.id===id);festivos[idx]=data}else festivos.push(data);
    saveDoc('festivos',data);closeModal();renderFestivos();updateDash();toast('Festivo guardado','ok');
}

function saveNoct(e,id){
    e.preventDefault();
    const data={id:id||uid(),mes:+$('mNMes').value,year:+$('mNYear').value,empId:$('mNEmp').value,s1:+$('mNS1').value,s2:+$('mNS2').value,s3:+$('mNS3').value,s4:+$('mNS4').value,s5:+$('mNS5').value};
    if(id){const idx=nocturnidad.findIndex(x=>x.id===id);nocturnidad[idx]=data}else nocturnidad.push(data);
    saveDoc('nocturnidad',data);closeModal();renderNocturnidad();updateDash();toast('Nocturnidad guardada','ok');
}

function saveHExtra(e,id){
    e.preventDefault();
    const data={id:id||uid(),fecha:$('mHFecha').value,empId:$('mHEmp').value,horas:+$('mHHoras').value,motivo:$('mHMotivo').value,estado:$('mHEstado').value};
    if(id){const idx=horasExtras.findIndex(x=>x.id===id);horasExtras[idx]=data}else horasExtras.push(data);
    saveDoc('horasExtras',data);closeModal();renderHorasExtras();updateDash();toast('Hora extra guardada','ok');
}

function saveBonif(e,id){
    e.preventDefault();
    const empId=$('mBEmp').value;
    const base=getBonifBase(empId);
    const dias=+$('mBDias').value,diasTemp=+$('mBDiasTemp').value,faltas=+$('mBFaltas').value;
    const proporcional=diasTemp>0?Math.round((base*dias/diasTemp)*100)/100:0;
    const descuento=diasTemp>0?Math.round((base*faltas/diasTemp)*100)/100:0;
    const importe=Math.max(0,proporcional-descuento);
    const data={id:id||uid(),year:+$('mBYear').value,temporada:$('mBTemp').value,empId,diasTrabajados:dias,diasTemporada:diasTemp,faltas,importe,estado:$('mBEstado').value};
    if(id){const idx=bonificaciones.findIndex(x=>x.id===id);bonificaciones[idx]=data}else bonificaciones.push(data);
    saveDoc('bonificaciones',data);closeModal();renderBonificaciones();toast('Bonificaci√≥n guardada','ok');
}

// === EDIT ===
function editTienda(id){openModal('tiendaModal',tiendas.find(x=>x.id===id))}
function editEmp(id){openModal('empModal',empleados.find(x=>x.id===id))}
function editCom(id){openModal('comisionModal',comisiones.find(x=>x.id===id))}
function editDiet(id){openModal('dietaModal',dietas.find(x=>x.id===id))}
function editDom(id){openModal('domModal',domingos.find(x=>x.id===id))}
function editFest(id){openModal('festModal',festivos.find(x=>x.id===id))}
function editNoct(id){openModal('noctModal',nocturnidad.find(x=>x.id===id))}
function editHExtra(id){openModal('hExtraModal',horasExtras.find(x=>x.id===id))}
function editBonif(id){openModal('bonifModal',bonificaciones.find(x=>x.id===id))}
function editObj(id){openModal('objModal',objetivos.find(x=>x.id===id))}

// === DELETE ===
function delTienda(id){if(confirm('¬øEliminar?')){tiendas=tiendas.filter(x=>x.id!==id);deleteDoc('tiendas',id);renderTiendas();toast('Eliminado','ok')}}
function delEmp(id){if(confirm('¬øEliminar?')){empleados=empleados.filter(x=>x.id!==id);deleteDoc('empleados',id);renderEmpleados();toast('Eliminado','ok')}}
function delCom(id){if(confirm('¬øEliminar?')){comisiones=comisiones.filter(x=>x.id!==id);deleteDoc('comisiones',id);renderComisiones();updateDash();toast('Eliminado','ok')}}
function delDiet(id){if(confirm('¬øEliminar?')){dietas=dietas.filter(x=>x.id!==id);deleteDoc('dietas',id);renderDietas();updateDash();toast('Eliminado','ok')}}
function delDom(id){if(confirm('¬øEliminar?')){domingos=domingos.filter(x=>x.id!==id);deleteDoc('domingos',id);renderDomingos();updateDash();toast('Eliminado','ok')}}
function delFest(id){if(confirm('¬øEliminar?')){festivos=festivos.filter(x=>x.id!==id);deleteDoc('festivos',id);renderFestivos();updateDash();toast('Eliminado','ok')}}
function delNoct(id){if(confirm('¬øEliminar?')){nocturnidad=nocturnidad.filter(x=>x.id!==id);deleteDoc('nocturnidad',id);renderNocturnidad();updateDash();toast('Eliminado','ok')}}
function delObj(id){if(confirm('¬øEliminar?')){objetivos=objetivos.filter(x=>x.id!==id);deleteDoc('objetivos',id);if($('objPageTb'))renderObjetivosPage();toast('Eliminado','ok')}}
function delHExtra(id){if(confirm('¬øEliminar?')){horasExtras=horasExtras.filter(x=>x.id!==id);deleteDoc('horasExtras',id);renderHorasExtras();updateDash();toast('Eliminado','ok')}}
function delBonif(id){if(confirm('¬øEliminar?')){bonificaciones=bonificaciones.filter(x=>x.id!==id);deleteDoc('bonificaciones',id);renderBonificaciones();toast('Eliminado','ok')}}

// === EXPORT ===
function exportExcel(){
    const mesVal=$('expMes').value,year=+$('expYear').value;
    const mes=mesVal?+mesVal:0;
    function mm(m,y){return(!mes||m==mes)&&y==year}
    const wb=XLSX.utils.book_new();

    const cF=comisiones.filter(c=>mm(c.mes,c.year));
    if(cF.length){
        const data=cF.map(c=>({Mes:MESES[c.mes],A√±o:c.year,Tienda:tiendas.find(t=>t.id===c.tiendaId)?.nombre,Empleado:empleados.find(e=>e.id===c.empId)?.nombre,Ventas:c.ventas,Ajustes:c.ajustes,Objetivo:c.obj||'Base','%':c.pct,Comisi√≥n:c.comision}));
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),'Comisiones');
    }
    const dF=dietas.filter(d=>{const dt=new Date(d.fechaViaje||d.fecha);return mm(dt.getMonth()+1,dt.getFullYear())});
    if(dF.length){
        const data=dF.map(d=>({FechaViaje:d.fechaViaje,FechaPago:d.fecha,Empleado:empleados.find(e=>e.id===d.empId)?.nombre,Tipo:DIETA_LABELS[d.tipo],D√≠as:d.dias,Dieta:d.importe,Incentivo:d.incentivo,Estado:DIETA_ESTADO_LABELS[d.estado]||d.estado,Motivo:d.motivo}));
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),'Dietas');
    }
    const doF=domingos.filter(d=>{const dt=new Date(d.fecha);return mm(dt.getMonth()+1,dt.getFullYear())});
    if(doF.length){
        const data=doF.map(d=>({Fecha:d.fecha,Tienda:tiendas.find(t=>t.id===d.tiendaId)?.nombre,Empleado:empleados.find(e=>e.id===d.empId)?.nombre,Autorizado:d.autorizado?'S√≠':'No'}));
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),'Domingos');
    }
    const fF=festivos.filter(f=>{const dt=new Date(f.fecha);return mm(dt.getMonth()+1,dt.getFullYear())});
    if(fF.length){
        const data=fF.map(f=>({Fecha:f.fecha,Festivo:f.nombre,Tienda:tiendas.find(t=>t.id===f.tiendaId)?.nombre,Empleado:empleados.find(e=>e.id===f.empId)?.nombre}));
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),'Festivos');
    }
    const nF=nocturnidad.filter(n=>mm(n.mes,n.year));
    if(nF.length){
        const data=nF.map(n=>({Mes:MESES[n.mes],A√±o:n.year,Empleado:empleados.find(e=>e.id===n.empId)?.nombre,S1:n.s1,S2:n.s2,S3:n.s3,S4:n.s4,S5:n.s5,Total:(n.s1||0)+(n.s2||0)+(n.s3||0)+(n.s4||0)+(n.s5||0)}));
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),'Nocturnidad');
    }
    const hF=horasExtras.filter(h=>{const dt=new Date(h.fecha);return mm(dt.getMonth()+1,dt.getFullYear())});
    if(hF.length){
        const data=hF.map(h=>({Fecha:h.fecha,Empleado:empleados.find(e=>e.id===h.empId)?.nombre,Horas:h.horas,Motivo:h.motivo,Estado:h.estado}));
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),'HorasExtras');
    }

    // Comisiones anuales
    const empAnual=empleados.filter(e=>e.pctAnual>0);
    if(empAnual.length){
        const cYear=comisiones.filter(c=>c.year==year);
        const data=empAnual.map(e=>{
            const t=tiendas.find(x=>x.id===e.tiendaId);
            const ventas=cYear.filter(c=>c.empId===e.id).reduce((s,c)=>s+(c.ventas||0)+(c.ajustes||0),0);
            const perdida=e.anualPerdido&&e.anualPerdido[year];
            const comAnual=perdida?0:Math.round(ventas*(e.pctAnual/100)*100)/100;
            return {Empleado:e.nombre,Tienda:t?.nombre||'-','%Anual':e.pctAnual,VentasAcumuladas:ventas,Comisi√≥nAnual:comAnual,Estado:perdida?'Perdida ('+perdida+')':e.estado};
        });
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),'ComisionesAnuales');
    }

    const bF=bonificaciones.filter(b=>b.year==year);
    if(bF.length){
        const data=bF.map(b=>{const emp=empleados.find(e=>e.id===b.empId);return {A√±o:b.year,Temporada:b.temporada,Empleado:emp?.nombre,Tipo:emp?.tipoContrato==='fija_discontinua'?'Fijo discontinuo':'Fijo ordinario',D√≠asTrabajados:b.diasTrabajados,D√≠asTemporada:b.diasTemporada,Faltas:b.faltas,Importe:b.importe,Estado:b.estado}});
        XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),'Bonificaciones');
    }
    if(!wb.SheetNames.length){toast('No hay datos para este periodo','err');return}
    XLSX.writeFile(wb,`Incidencias_${mes?MESES[mes]:'Anual'}_${year}.xlsx`);
    toast('Excel exportado','ok');
}

// Nav
document.querySelectorAll('.nav-item').forEach(n=>n.onclick=()=>{renderPage(n.dataset.p);$('sidebar').classList.remove('open')});
</script>
</body>
</html>
